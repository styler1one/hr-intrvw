<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volentis Interview Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-enter {
            animation: slideIn 0.3s ease;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        .sidebar-collapsed {
            width: 0;
            overflow: hidden;
        }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-dark {
            background: rgba(45, 45, 45, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Toast animations */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .toast-enter {
            animation: slideInRight 0.3s ease;
        }
        
        .toast-exit {
            animation: slideOutRight 0.3s ease;
        }
        
        /* Smooth transitions */
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        
        /* Mobile sidebar overlay */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                bottom: 0;
                z-index: 50;
                transition: left 0.3s ease;
            }
            
            #sidebar.mobile-open {
                left: 0;
            }
            
            #sidebarBackdrop {
                display: none;
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            #sidebarBackdrop.show {
                display: block;
                opacity: 1;
            }
            
            #mainContent {
                width: 100%;
            }
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e5e5e5;
        }
        
        body.dark-mode .bg-white {
            background-color: #2d2d2d !important;
        }
        
        body.dark-mode .bg-gray-50 {
            background-color: #1a1a1a !important;
        }
        
        body.dark-mode .bg-gray-100 {
            background-color: #2d2d2d !important;
        }
        
        body.dark-mode .bg-gray-200 {
            background-color: #3d3d3d !important;
        }
        
        body.dark-mode .text-gray-600 {
            color: #a0a0a0 !important;
        }
        
        body.dark-mode .text-gray-700 {
            color: #b0b0b0 !important;
        }
        
        body.dark-mode .text-gray-800 {
            color: #d0d0d0 !important;
        }
        
        body.dark-mode .text-gray-900 {
            color: #e5e5e5 !important;
        }
        
        body.dark-mode .border-gray-200 {
            border-color: #3d3d3d !important;
        }
        
        body.dark-mode .border-gray-300 {
            border-color: #4d4d4d !important;
        }
        
        body.dark-mode .hover\:bg-gray-100:hover {
            background-color: #3d3d3d !important;
        }
        
        body.dark-mode .hover\:bg-gray-200:hover {
            background-color: #4d4d4d !important;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden transition-colors duration-300">
    <!-- Mobile Sidebar Backdrop -->
    <div id="sidebarBackdrop" onclick="closeMobileSidebar()"></div>
    
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-gray-900 text-white flex flex-col transition-all duration-300">
            <!-- Sidebar Header -->
            <div class="p-4 border-b border-gray-700">
                <button onclick="newSession()" class="w-full flex items-center gap-3 px-4 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span class="font-medium">Nieuw Interview</span>
                </button>
            </div>

            <!-- Search Bar -->
            <div class="px-4 py-3 border-b border-gray-700">
                <div class="relative">
                    <input 
                        type="text" 
                        id="sessionSearch"
                        placeholder="Zoek sessies..."
                        class="w-full bg-gray-800 text-white text-sm px-4 py-2 pl-10 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        oninput="filterSessions(this.value)"
                        onkeydown="handleSearchKeydown(event)"
                    />
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <button 
                        id="clearSearch"
                        onclick="clearSearch()"
                        class="absolute right-3 top-2.5 text-gray-400 hover:text-white hidden"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Sessions List -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-3">
                <div class="text-xs font-semibold text-gray-400 px-3 mb-2">RECENTE SESSIES</div>
                <div id="sessionsList" class="space-y-1">
                    <!-- Sessions will be loaded here -->
                </div>
                <div id="noResults" class="hidden text-sm text-gray-500 px-3 py-4 text-center">
                    Geen sessies gevonden
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center gap-3 px-3 py-2 mb-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-sm font-bold">
                        V
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium truncate">Volentis HR</div>
                        <div class="text-xs text-gray-400">Interview Agent</div>
                    </div>
                </div>
                
                <!-- Dark Mode Toggle -->
                <button 
                    onclick="toggleDarkMode()"
                    class="w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors text-sm"
                    title="Toggle Dark Mode"
                >
                    <div class="flex items-center gap-2">
                        <svg id="darkModeIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                        <span id="darkModeText">Dark Mode</span>
                    </div>
                    <div id="darkModeToggle" class="relative w-10 h-5 bg-gray-700 rounded-full transition-colors">
                        <div id="darkModeSlider" class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform"></div>
                    </div>
                </button>
            </div>
        </div>

        <!-- Main Content -->
            <div id="mainContent" class="flex-1 flex flex-col overflow-hidden">
                <!-- Mobile Header with Hamburger -->
                <div class="md:hidden bg-white border-b border-gray-200 px-4 py-3 flex items-center gap-3">
                    <button onclick="toggleMobileSidebar()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <h1 id="mobileSessionTitle" class="text-base font-semibold text-gray-900 truncate">Volentis Interview Agent</h1>
                    </div>
                </div>
                
                <!-- Top Bar (Desktop only) -->
                <div class="hidden md:flex bg-white border-b border-gray-200 px-4 py-3 items-center gap-4">
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <div class="flex-1">
                    <h1 id="sessionTitle" class="text-lg font-semibold text-gray-800">Volentis Interview Agent</h1>
                    <div id="sessionSubtitle" class="text-sm text-gray-500">Start een nieuw interview om te beginnen</div>
                </div>
                <div id="progressIndicator" class="hidden flex items-center gap-3">
                    <div class="text-right">
                        <div class="text-xs text-gray-500">Voortgang</div>
                        <div id="progressPercent" class="text-sm font-semibold text-gray-800">0%</div>
                    </div>
                    <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="progressBarTop" class="h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Interview Controls -->
                <div id="interviewControls" class="hidden flex items-center gap-2">
                    <button 
                        id="backButton"
                        onclick="goBackToPreviousQuestion()"
                        class="hidden px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-2"
                        title="Terug naar vorige vraag"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Terug
                    </button>
                    <button 
                        id="pauseButton"
                        onclick="pauseInterview()"
                        class="px-4 py-2 text-sm bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors flex items-center gap-2"
                        title="Pauzeer interview"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Pauzeren
                    </button>
                    <button 
                        id="resumeButton"
                        onclick="resumeInterview()"
                        class="hidden px-4 py-2 text-sm bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center gap-2"
                        title="Hervat interview"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Hervatten
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center p-8 text-center">
                    <div class="max-w-2xl space-y-6">
                        <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto shadow-lg">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900 mb-3">Welkom bij de Volentis HR Agent</h2>
                            <p class="text-lg text-gray-600">Samen gaan we alle belangrijke informatie doornemen om de Volentis HR Agent succesvol te implementeren in jouw organisatie</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                            <div class="bg-white p-5 rounded-xl border border-gray-200 hover:border-blue-300 transition-colors">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mb-3">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="font-semibold text-gray-900 mb-1">Jouw Situatie</h3>
                                <p class="text-sm text-gray-600">We inventariseren je organisatie en HR-uitdagingen</p>
                            </div>

                            <div class="bg-white p-5 rounded-xl border border-gray-200 hover:border-purple-300 transition-colors">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mb-3">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </div>
                                <h3 class="font-semibold text-gray-900 mb-1">Implementatiestrategie</h3>
                                <p class="text-sm text-gray-600">Op maat gemaakt plan voor jouw organisatie</p>
                            </div>

                            <div class="bg-white p-5 rounded-xl border border-gray-200 hover:border-green-300 transition-colors">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mb-3">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="font-semibold text-gray-900 mb-1">¬±45 minuten</h3>
                                <p class="text-sm text-gray-600">Interactief gesprek, pauzeren is mogelijk</p>
                            </div>
                        </div>

                        <button onclick="showTemplateSelector()" class="inline-flex items-center gap-2 px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
                            <span>Start Interview</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chatMessages" class="hidden max-w-3xl mx-auto py-8 px-4 space-y-6">
                    <!-- Messages will be added here -->
                </div>
            </div>

            <!-- Input Area -->
            <div id="inputArea" class="hidden border-t border-gray-200 bg-white">
                <div class="max-w-3xl mx-auto p-4">
                    <div class="flex gap-3 items-end">
                        <div class="flex-1 relative">
                            <textarea 
                                id="userInput" 
                                placeholder="Type je antwoord..."
                                rows="1"
                                class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none max-h-32"
                                onkeydown="handleInputKeydown(event)"
                                oninput="autoResize(this)"
                            ></textarea>
                            <button 
                                id="sendButton"
                                onclick="sendMessage()" 
                                class="absolute right-2 bottom-2 p-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- AI Suggestions -->
                    <div id="aiSuggestions" class="hidden mt-3 flex flex-wrap gap-2">
                        <div class="text-xs text-gray-500 font-medium mb-1 w-full flex items-center gap-2">
                            <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            AI Suggesties:
                        </div>
                        <div id="suggestionChips" class="flex flex-wrap gap-2">
                            <!-- Suggestion chips will be added here -->
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500 mt-2 text-center">
                        Druk op Enter om te versturen, Shift+Enter voor een nieuwe regel
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
        <!-- Toasts will be added here -->
    </div>

    <!-- Custom Modal -->
    <div id="customModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div id="modalIcon" class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
                        <!-- Icon will be inserted here -->
                    </div>
                    <div class="flex-1">
                        <h3 id="modalTitle" class="text-xl font-semibold text-gray-900"></h3>
                        <p id="modalMessage" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                </div>
                <div id="modalButtons" class="flex gap-3 justify-end mt-6">
                    <!-- Buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Template Selector Modal -->
    <div id="templateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 transform transition-all">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Kies je Interview Template</h2>
                <p class="text-gray-600 mb-6">Selecteer het type interview dat het beste bij je situatie past</p>
                
                <div id="templateOptions" class="space-y-4">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let sessions = [];
        let currentSessionId = null;
        let currentSession = null;  // Store full session data
        let ws = null;
        let isPaused = false;
        let messageHistory = [];  // Track all messages for back navigation
        let currentQuestion = '';  // Track current question for suggestions
        let conversationContext = {
            sector: '',
            role: '',
            challenges: [],
            hasSystem: null
        };  // Track conversation context for better suggestions
        let modalResolve = null;
        let currentTotalFases = 11;  // Track total fases for current template

        // Custom Modal Functions
        function showModal(title, message, type = 'info', buttons = []) {
            return new Promise((resolve) => {
                modalResolve = resolve;
                
                const modal = document.getElementById('customModal');
                const modalIcon = document.getElementById('modalIcon');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');
                const modalButtons = document.getElementById('modalButtons');
                
                // Set icon based on type
                let iconHTML = '';
                let iconBgClass = '';
                
                if (type === 'confirm') {
                    iconBgClass = 'bg-blue-100';
                    iconHTML = `<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                } else if (type === 'error') {
                    iconBgClass = 'bg-red-100';
                    iconHTML = `<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                } else if (type === 'success') {
                    iconBgClass = 'bg-green-100';
                    iconHTML = `<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                } else {
                    iconBgClass = 'bg-gray-100';
                    iconHTML = `<svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                }
                
                modalIcon.className = `w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 ${iconBgClass}`;
                modalIcon.innerHTML = iconHTML;
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                
                // Set buttons
                modalButtons.innerHTML = buttons.map(btn => {
                    const btnClass = btn.primary 
                        ? 'px-6 py-2.5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-md hover:shadow-lg'
                        : 'px-6 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-all duration-200';
                    
                    return `<button onclick="closeModal(${btn.value})" class="${btnClass}">${btn.label}</button>`;
                }).join('');
                
                modal.classList.remove('hidden');
            });
        }

        function closeModal(value) {
            const modal = document.getElementById('customModal');
            modal.classList.add('hidden');
            if (modalResolve) {
                modalResolve(value);
                modalResolve = null;
            }
        }

        // Load sessions from localStorage and verify with server
        async function loadSessions() {
            const stored = localStorage.getItem('volentis_sessions');
            if (stored) {
                sessions = JSON.parse(stored);
                
                // Verify sessions still exist on server
                const validSessions = [];
                for (const session of sessions) {
                    try {
                        const response = await fetch(`${API_BASE}/api/session/${session.id}`);
                        if (response.ok) {
                            validSessions.push(session);
                        }
                    } catch (error) {
                        console.log(`Session ${session.id} not found on server`);
                    }
                }
                
                sessions = validSessions;
                filteredSessions = sessions;  // Reset filter
                saveSessions();
                renderSessions();
            }
        }

        // Save sessions to localStorage
        function saveSessions() {
            localStorage.setItem('volentis_sessions', JSON.stringify(sessions));
        }

        // Filter sessions based on search query
        let filteredSessions = sessions;
        
        function filterSessions(query) {
            const searchInput = document.getElementById('sessionSearch');
            const clearBtn = document.getElementById('clearSearch');
            const noResults = document.getElementById('noResults');
            
            // Show/hide clear button
            if (query) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
            
            // Filter sessions
            if (query.trim() === '') {
                filteredSessions = sessions;
            } else {
                const lowerQuery = query.toLowerCase();
                filteredSessions = sessions.filter(session => {
                    return session.title.toLowerCase().includes(lowerQuery) ||
                           session.date.toLowerCase().includes(lowerQuery) ||
                           session.id.toLowerCase().includes(lowerQuery);
                });
            }
            
            // Show/hide no results message
            if (filteredSessions.length === 0 && query.trim() !== '') {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }
            
            renderSessions();
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('sessionSearch');
            searchInput.value = '';
            filterSessions('');
            searchInput.focus();
        }
        
        function handleSearchKeydown(event) {
            if (event.key === 'Escape') {
                clearSearch();
            }
        }

        // Render sessions list
        function renderSessions() {
            const list = document.getElementById('sessionsList');
            if (sessions.length === 0) {
                list.innerHTML = '<div class="text-sm text-gray-500 px-3 py-2">Nog geen sessies</div>';
                return;
            }
            
            if (filteredSessions.length === 0) {
                list.innerHTML = '';
                return;
            }

            list.innerHTML = filteredSessions.map(session => `
                <div class="group relative flex items-center gap-1 px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors ${session.id === currentSessionId ? 'bg-gray-800' : ''}">
                    <button 
                        onclick="selectSession('${session.id}')"
                        class="flex-1 text-left min-w-0"
                    >
                        <div class="text-sm font-medium truncate">${escapeHtml(session.title)}</div>
                        <div class="text-xs text-gray-400">${session.date}</div>
                    </button>
                    <div class="relative opacity-0 group-hover:opacity-100 transition-opacity">
                        <button 
                            onclick="event.stopPropagation(); toggleSessionMenu('${session.id}')"
                            class="p-1.5 hover:bg-gray-700 rounded transition-all"
                            title="Opties"
                        >
                            <svg class="w-4 h-4 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                            </svg>
                        </button>
                        <div id="menu-${session.id}" class="hidden absolute right-0 mt-1 w-48 bg-gray-800 rounded-lg shadow-lg border border-gray-700 z-50">
                            <button 
                                onclick="event.stopPropagation(); exportSessionPDF('${session.id}'); closeSessionMenu('${session.id}')"
                                class="w-full flex items-center gap-2 px-4 py-2 text-sm text-white hover:bg-gray-700 rounded-t-lg transition-colors"
                            >
                                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export naar PDF
                            </button>
                            <button 
                                onclick="event.stopPropagation(); renameSession('${session.id}'); closeSessionMenu('${session.id}')"
                                class="w-full flex items-center gap-2 px-4 py-2 text-sm text-white hover:bg-gray-700 transition-colors"
                            >
                                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                </svg>
                                Hernoemen
                            </button>
                            <button 
                                onclick="event.stopPropagation(); deleteSession('${session.id}'); closeSessionMenu('${session.id}')"
                                class="w-full flex items-center gap-2 px-4 py-2 text-sm text-white hover:bg-gray-700 rounded-b-lg transition-colors"
                            >
                                <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Verwijderen
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle session menu
        function toggleSessionMenu(sessionId) {
            const menu = document.getElementById(`menu-${sessionId}`);
            const allMenus = document.querySelectorAll('[id^="menu-"]');
            
            // Close all other menus
            allMenus.forEach(m => {
                if (m.id !== `menu-${sessionId}`) {
                    m.classList.add('hidden');
                }
            });
            
            // Toggle current menu
            menu.classList.toggle('hidden');
        }
        
        // Close session menu
        function closeSessionMenu(sessionId) {
            const menu = document.getElementById(`menu-${sessionId}`);
            if (menu) {
                menu.classList.add('hidden');
            }
        }
        
        // Close all menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('[id^="menu-"]') && !e.target.closest('button[onclick*="toggleSessionMenu"]')) {
                const allMenus = document.querySelectorAll('[id^="menu-"]');
                allMenus.forEach(menu => menu.classList.add('hidden'));
            }
        });

        // Rename session
        async function renameSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // Create custom input modal
            const modal = document.getElementById('customModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = document.getElementById('modalButtons');
            
            // Set icon
            modalIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 bg-purple-100';
            modalIcon.innerHTML = `<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
            </svg>`;
            
            modalTitle.textContent = 'Sessie Hernoemen';
            modalMessage.innerHTML = `
                <input 
                    type="text" 
                    id="sessionNameInput" 
                    value="${escapeHtml(session.title)}"
                    class="w-full px-4 py-2 mt-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    placeholder="Voer een nieuwe naam in..."
                    onkeydown="if(event.key === 'Enter') document.getElementById('saveNameBtn').click()"
                />
            `;
            
            modalButtons.innerHTML = `
                <button onclick="closeModal(false)" class="px-6 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-all duration-200">
                    Annuleren
                </button>
                <button id="saveNameBtn" onclick="saveSessionName('${sessionId}')" class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:from-purple-700 hover:to-blue-700 transition-all duration-200 shadow-md hover:shadow-lg">
                    Opslaan
                </button>
            `;
            
            modal.classList.remove('hidden');
            
            // Focus input after modal opens
            setTimeout(() => {
                const input = document.getElementById('sessionNameInput');
                input.focus();
                input.select();
            }, 100);
        }
        
        // Save session name
        function saveSessionName(sessionId) {
            const input = document.getElementById('sessionNameInput');
            const newName = input.value.trim();
            
            if (!newName) {
                return;
            }
            
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                session.title = newName;
                saveSessions();
                renderSessions();
                
                // Update title if this is the current session
                if (sessionId === currentSessionId) {
                    updateSessionTitle(newName);
                }
            }
            
            closeModal(true);
        }

        // Export session to PDF
        async function exportSessionPDF(sessionId) {
            try {
                // Show loading message (without await so it doesn't block)
                showModal(
                    'PDF Genereren',
                    'Even geduld, het PDF rapport wordt gegenereerd...',
                    'info',
                    []
                );
                
                // Small delay to show modal
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Get session data from local storage or current session
                const session = sessions.find(s => s.id === sessionId);
                if (!session) {
                    throw new Error('Sessie niet gevonden in lokale opslag');
                }
                
                // Use current session data if this is the active session
                let sessionData;
                if (sessionId === currentSessionId && currentSession) {
                    sessionData = {
                        conversation_history: currentSession.messages || [],
                        status: 'in_progress'
                    };
                } else {
                    // Try to fetch from backend, but fallback to empty if not found
                    try {
                        const response = await fetch(`${API_BASE}/api/session/${sessionId}/export`);
                        if (response.ok) {
                            sessionData = await response.json();
                        } else {
                            // Fallback: create from chat messages in DOM
                            sessionData = {
                                conversation_history: [],
                                status: 'completed'
                            };
                        }
                    } catch (error) {
                        console.log('Could not fetch from backend, using local data');
                        sessionData = {
                            conversation_history: [],
                            status: 'completed'
                        };
                    }
                }
                
                // Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const maxWidth = pageWidth - (margin * 2);
                
                // Add header background
                doc.setFillColor(59, 130, 246); // Blue gradient start
                doc.rect(0, 0, pageWidth, 40, 'F');
                
                // Header
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('Volentis HR Implementation', margin, 20);
                yPos += 8;
                
                // Subtitle
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text('Interview Rapport', margin, yPos);
                yPos += 25;
                
                // Info Box
                doc.setFillColor(245, 247, 250); // Light gray background
                doc.roundedRect(margin, yPos, maxWidth, 35, 3, 3, 'F');
                yPos += 10;
                
                // Session Info
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(50, 50, 50);
                doc.text('Sessie Informatie', margin + 5, yPos);
                yPos += 8;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                doc.text(`üìã Titel: ${session.title}`, margin + 5, yPos);
                yPos += 6;
                doc.text(`üìÖ Datum: ${session.date}`, margin + 5, yPos);
                yPos += 6;
                doc.text(`‚úì Status: ${sessionData.status === 'completed' ? 'Voltooid' : 'In uitvoering'}`, margin + 5, yPos);
                yPos += 15;
                
                // Conversation Section Header
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(50, 50, 50);
                doc.text('Interview Conversatie', margin, yPos);
                yPos += 3;
                
                // Underline
                doc.setDrawColor(59, 130, 246);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, margin + 60, yPos);
                yPos += 10;
                
                if (sessionData.conversation_history && sessionData.conversation_history.length > 0) {
                    sessionData.conversation_history.forEach((msg, index) => {
                        // Check if we need a new page
                        if (yPos > 260) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        // Message bubble background
                        const lines = doc.splitTextToSize(msg.content, maxWidth - 10);
                        const bubbleHeight = (lines.length * 5) + 8;
                        
                        if (msg.role === 'user') {
                            // User message - blue bubble on right
                            doc.setFillColor(59, 130, 246);
                            doc.roundedRect(margin + 20, yPos - 3, maxWidth - 20, bubbleHeight, 2, 2, 'F');
                            
                            // Label
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(255, 255, 255);
                            doc.text('Jij', margin + 25, yPos + 3);
                            yPos += 7;
                            
                            // Content
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(10);
                            doc.text(lines, margin + 25, yPos);
                        } else {
                            // Agent message - gray bubble on left
                            doc.setFillColor(245, 247, 250);
                            doc.roundedRect(margin, yPos - 3, maxWidth - 20, bubbleHeight, 2, 2, 'F');
                            
                            // Label
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(147, 51, 234);
                            doc.text('Volentis Agent', margin + 5, yPos + 3);
                            yPos += 7;
                            
                            // Content
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(10);
                            doc.setTextColor(50, 50, 50);
                            doc.text(lines, margin + 5, yPos);
                        }
                        
                        yPos += (lines.length * 5) + 8;
                    });
                } else {
                    doc.setFillColor(255, 243, 205); // Light yellow
                    doc.roundedRect(margin, yPos, maxWidth, 20, 2, 2, 'F');
                    doc.setFontSize(10);
                    doc.setTextColor(120, 80, 0);
                    doc.text('‚ö†Ô∏è Geen conversatie geschiedenis beschikbaar voor deze sessie.', margin + 5, yPos + 10);
                    yPos += 25;
                }
                
                // Footer on all pages
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    
                    // Footer line
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(margin, pageHeight - 20, pageWidth - margin, pageHeight - 20);
                    
                    // Footer text
                    doc.setFontSize(8);
                    doc.setTextColor(120, 120, 120);
                    doc.setFont(undefined, 'normal');
                    
                    // Left: Volentis
                    doc.text('Volentis HR Implementation', margin, pageHeight - 12);
                    
                    // Center: Date
                    doc.text(
                        `Gegenereerd: ${new Date().toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })}`,
                        pageWidth / 2,
                        pageHeight - 12,
                        { align: 'center' }
                    );
                    
                    // Right: Page number
                    doc.text(
                        `Pagina ${i}/${pageCount}`,
                        pageWidth - margin,
                        pageHeight - 12,
                        { align: 'right' }
                    );
                }
                
                // Save PDF
                const fileName = `Volentis_Interview_${session.title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                // Close loading modal and show success toast
                closeModal(true);
                showToast('PDF succesvol gedownload!', 'success');
                
                await showModal(
                    'PDF Gegenereerd',
                    `Het rapport is succesvol gedownload als "${fileName}".`,
                    'success',
                    [{ label: 'OK', value: true, primary: true }]
                );
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                closeModal(true);
                await showModal(
                    'Fout bij PDF Generatie',
                    'Er is een fout opgetreden bij het genereren van het PDF rapport: ' + error.message,
                    'error',
                    [{ label: 'OK', value: true, primary: true }]
                );
            }
        }

        // Delete session
        async function deleteSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const result = await showModal(
                'Sessie Verwijderen?',
                `Weet je zeker dat je "${session.title}" wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt.`,
                'error',
                [
                    { label: 'Annuleren', value: false, primary: false },
                    { label: 'Verwijderen', value: true, primary: true }
                ]
            );
            
            if (result) {
                // Remove from sessions array
                sessions = sessions.filter(s => s.id !== sessionId);
                filteredSessions = sessions;  // Update filtered sessions too
                saveSessions();
                renderSessions();
                
                // If this was the current session, show welcome screen
                if (sessionId === currentSessionId) {
                    // Close WebSocket
                    if (ws) {
                        ws.close();
                        ws = null;
                    }
                    
                    // Reset to welcome screen
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                    document.getElementById('chatMessages').classList.add('hidden');
                    document.getElementById('inputArea').classList.add('hidden');
                    document.getElementById('progressIndicator').classList.add('hidden');
                    
                    // Reset title
                    updateSessionTitle('Volentis Interview Agent', 'Start een nieuw interview om te beginnen');
                    
                    currentSessionId = null;
                }
                
                // Show success message
                await showModal(
                    'Sessie Verwijderd',
                    'De sessie is succesvol verwijderd.',
                    'success',
                    [{ label: 'OK', value: true, primary: true }]
                );
            }
        }

        // Pause/Resume Interview
        function pauseInterview() {
            isPaused = true;
            
            // Hide pause button, show resume button
            document.getElementById('pauseButton').classList.add('hidden');
            document.getElementById('resumeButton').classList.remove('hidden');
            
            // Disable input
            const input = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendButton');
            input.disabled = true;
            input.placeholder = 'Interview gepauzeerd - klik op "Hervatten" om verder te gaan';
            sendBtn.disabled = true;
            
            // Show notification
            showModal(
                'Interview Gepauzeerd',
                'Je kunt op elk moment hervatten waar je was gebleven. Je voortgang is opgeslagen.',
                'info',
                [{ label: 'OK', value: true, primary: true }]
            );
        }
        
        function resumeInterview() {
            isPaused = false;
            
            // Hide resume button, show pause button
            document.getElementById('resumeButton').classList.add('hidden');
            document.getElementById('pauseButton').classList.remove('hidden');
            
            // Enable input
            const input = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendButton');
            input.disabled = false;
            input.placeholder = 'Type je antwoord...';
            sendBtn.disabled = false;
            input.focus();
        }
        
        // Back Navigation
        function goBackToPreviousQuestion() {
            if (messageHistory.length < 2) {
                showModal(
                    'Geen Vorige Vraag',
                    'Je bent al bij de eerste vraag van het interview.',
                    'info',
                    [{ label: 'OK', value: true, primary: true }]
                );
                return;
            }
            
            // Remove last 2 messages (user answer + agent question)
            messageHistory.pop();
            messageHistory.pop();
            
            // Re-render messages
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messageHistory.forEach(msg => {
                addMessage(msg.role, msg.content);
            });
            
            // Update back button visibility
            updateBackButtonVisibility();
            
            // Focus input
            document.getElementById('userInput').focus();
        }
        
        function updateBackButtonVisibility() {
            const backBtn = document.getElementById('backButton');
            // Show back button if we have at least 2 messages (welcome + first Q&A)
            if (messageHistory.length >= 4) {
                backBtn.classList.remove('hidden');
            } else {
                backBtn.classList.add('hidden');
            }
        }

        // AI Suggestions
        async function generateSuggestions(question) {
            // First hide any existing suggestions
            hideSuggestions();
            
            currentQuestion = question;
            
            // Skip suggestions for the first question (welcome message)
            if (!currentSession || !currentSession.messages || currentSession.messages.length <= 1) {
                return;
            }
            
            // Show loading state for suggestions
            showSuggestionsLoading();
            
            // Generate context-aware suggestions using Claude with timeout
            try {
                // Create timeout promise (15 seconds - suggesties mogen langer duren)
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout')), 15000)
                );
                
                // Create fetch promise
                const fetchPromise = fetch(`${API_BASE}/api/suggestions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        session: currentSession
                    })
                });
                
                // Race between fetch and timeout
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.suggestions && data.suggestions.length > 0) {
                        showSuggestions(data.suggestions);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                // If timeout or error, just hide suggestions (no fallback)
                hideSuggestions();
                return;
            }
            
            // If API returns empty suggestions, hide them
            hideSuggestions();
        }
        
        function showSuggestionsLoading() {
            const container = document.getElementById('aiSuggestions');
            const chipsContainer = document.getElementById('suggestionChips');
            
            // Show loading state
            chipsContainer.innerHTML = `
                <div class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-50 to-blue-50 text-gray-500 rounded-full text-sm border border-purple-200">
                    <div class="flex gap-1">
                        <div class="w-1.5 h-1.5 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-1.5 h-1.5 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-1.5 h-1.5 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                    <span class="text-xs">AI genereert suggesties...</span>
                </div>
            `;
            
            container.classList.remove('hidden');
        }
        
        function showSuggestions(suggestions) {
            const container = document.getElementById('aiSuggestions');
            const chipsContainer = document.getElementById('suggestionChips');
            
            if (suggestions.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            chipsContainer.innerHTML = suggestions.map(suggestion => `
                <button 
                    onclick="useSuggestion('${escapeHtml(suggestion).replace(/'/g, "\\'")}')"
                    class="px-4 py-2 bg-gradient-to-r from-purple-50 to-blue-50 hover:from-purple-100 hover:to-blue-100 text-gray-700 rounded-full text-sm border border-purple-200 hover:border-purple-300 transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-2"
                >
                    <svg class="w-3 h-3 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    ${escapeHtml(suggestion)}
                </button>
            `).join('');
            
            container.classList.remove('hidden');
            
            // Auto-scroll to bottom to show suggestions without covering the last message
            // Wait for suggestions to render
            setTimeout(() => {
                const chatContainer = document.getElementById('chatMessages').parentElement;
                chatContainer.scrollTo({
                    top: chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        function useSuggestion(suggestion) {
            const input = document.getElementById('userInput');
            
            // If input is empty, just set the suggestion
            if (!input.value.trim()) {
                input.value = suggestion;
            } else {
                // If input has content, append with comma
                input.value = input.value.trim() + ', ' + suggestion;
            }
            
            input.focus();
            autoResize(input);
            
            // Don't hide suggestions - allow multiple selections
            // User can manually hide by typing or sending
        }
        
        function hideSuggestions() {
            const container = document.getElementById('aiSuggestions');
            container.classList.add('hidden');
            // Also clear the suggestions
            document.getElementById('suggestionChips').innerHTML = '';
        }
        
        // Update conversation context based on user answers
        function updateContext(userMessage) {
            const msg = userMessage.toLowerCase();
            
            // Detect sector
            if (msg.includes('tech') || msg.includes('technologie')) {
                conversationContext.sector = 'tech';
            } else if (msg.includes('zorg') || msg.includes('healthcare')) {
                conversationContext.sector = 'zorg';
            } else if (msg.includes('productie') || msg.includes('manufacturing')) {
                conversationContext.sector = 'productie';
            }
            
            // Detect role
            if (msg.includes('hr manager')) {
                conversationContext.role = 'hr manager';
            } else if (msg.includes('business partner')) {
                conversationContext.role = 'business partner';
            } else if (msg.includes('director')) {
                conversationContext.role = 'director';
            }
            
            // Detect challenges
            if (msg.includes('repetitieve') || msg.includes('repetitive')) {
                conversationContext.challenges.push('repetitieve');
            }
            if (msg.includes('werkdruk') || msg.includes('workload')) {
                conversationContext.challenges.push('werkdruk');
            }
            if (msg.includes('onboarding')) {
                conversationContext.challenges.push('onboarding');
            }
            if (msg.includes('inconsistent') || msg.includes('informatie')) {
                conversationContext.challenges.push('inconsistent');
            }
        }

        // Dark Mode
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        function initDarkMode() {
            // Check system preference if no saved preference
            if (localStorage.getItem('darkMode') === null) {
                isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                updateDarkModeUI(true);
            }
        }
        
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            updateDarkModeUI(isDarkMode);
        }
        
        // Helper function to update session title in both mobile and desktop headers
        function updateSessionTitle(title, subtitle = '') {
            // Update desktop header
            document.getElementById('sessionTitle').textContent = title;
            if (subtitle) {
                document.getElementById('sessionSubtitle').textContent = subtitle;
            }
            
            // Update mobile header
            const mobileTitle = document.getElementById('mobileSessionTitle');
            if (mobileTitle) {
                mobileTitle.textContent = title;
            }
        }
        
        // Mobile sidebar functions
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            sidebar.classList.toggle('mobile-open');
            backdrop.classList.toggle('show');
            
            // Prevent body scroll when sidebar is open
            if (sidebar.classList.contains('mobile-open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            sidebar.classList.remove('mobile-open');
            backdrop.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        // Close mobile sidebar when clicking on a session
        function selectSession(sessionId) {
            loadSession(sessionId);
            closeMobileSidebar();
        }
        
        function updateDarkModeUI(dark) {
            const toggle = document.getElementById('darkModeToggle');
            const slider = document.getElementById('darkModeSlider');
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (dark) {
                toggle.classList.add('bg-blue-600');
                toggle.classList.remove('bg-gray-700');
                slider.style.transform = 'translateX(20px)';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
                text.textContent = 'Light Mode';
            } else {
                toggle.classList.remove('bg-blue-600');
                toggle.classList.add('bg-gray-700');
                slider.style.transform = 'translateX(0)';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
                text.textContent = 'Dark Mode';
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('sidebar-collapsed');
        }

        // New session
        async function newSession() {
            if (currentSessionId && ws) {
                const result = await showModal(
                    'Nieuw Interview Starten?',
                    'De huidige sessie wordt opgeslagen en je kunt er later naar terugkeren.',
                    'confirm',
                    [
                        { label: 'Annuleren', value: false, primary: false },
                        { label: 'Start Nieuw Interview', value: true, primary: true }
                    ]
                );
                
                if (result) {
                    // Close current WebSocket
                    if (ws) {
                        ws.close();
                        ws = null;
                    }
                    
                    // Reset UI
                    document.getElementById('chatMessages').innerHTML = '';
                    currentSessionId = null;
                    
                    // Show template selector
                    showTemplateSelector();
                }
            } else {
                // No active session, show template selector
                showTemplateSelector();
            }
        }

        // API Base URL - auto-detect
        const API_BASE = window.location.origin;
        
        // Show template selector
        async function showTemplateSelector() {
            const modal = document.getElementById('templateModal');
            const templateOptions = document.getElementById('templateOptions');
            
            // Fetch templates from API
            const response = await fetch(`${API_BASE}/api/templates`);
            const data = await response.json();
            const templates = data.templates;
            
            // Render template options
            templateOptions.innerHTML = Object.values(templates).map(template => `
                <div onclick="selectTemplate('${template.id}')" class="border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-purple-500 hover:bg-purple-50 transition-all duration-200 group">
                    <div class="flex items-start gap-4">
                        <div class="text-4xl">${template.icon}</div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-900 group-hover:text-purple-600">${template.name}</h3>
                            <p class="text-sm text-gray-600 mt-1">${template.description}</p>
                            <div class="flex gap-4 mt-3 text-sm text-gray-500">
                                <span>‚è±Ô∏è ${template.duration}</span>
                                <span>üìä ${template.total_fases} fases</span>
                                <span>‚ùì ${template.questions_per_fase} vragen/fase</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 italic">${template.use_case}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }
        
        // Select template and start interview
        async function selectTemplate(templateId) {
            // Hide template modal
            document.getElementById('templateModal').classList.add('hidden');
            
            // Reset state
            messageHistory = [];
            isPaused = false;
            conversationContext = { sector: '', role: '', challenges: [], hasSystem: null };
            
            // Hide welcome, show chat
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
            document.getElementById('progressIndicator').classList.remove('hidden');
            document.getElementById('interviewControls').classList.remove('hidden');

            // Create session with selected template
            const response = await fetch(`${API_BASE}/api/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    template_id: templateId
                })
            });
            const data = await response.json();
            currentSessionId = data.session_id;
            const template = data.template;
            
            // Initialize session data
            currentSession = {
                session_id: currentSessionId,
                template_id: templateId,
                template_name: template.name,
                total_fases: template.total_fases,
                current_fase: 1,
                messages: [],
                created_at: new Date().toISOString()
            };
            
            // Set current total fases for progress tracking
            currentTotalFases = template.total_fases;

            // Add to sessions list (title will be updated after first message)
            const newSession = {
                id: currentSessionId,
                title: 'Nieuw Interview',
                date: new Date().toLocaleDateString('nl-NL'),
                timestamp: Date.now(),
                messageCount: 0
            };
            sessions.unshift(newSession);
            saveSessions();
            renderSessions();
            
            // Show success toast
            showToast('Interview gestart!', 'success');

            // Update UI
            updateSessionTitle(`${template.name} in uitvoering`, `Fase 1/${template.total_fases}: Intro & context`);

            // Send initial message to get first question (REST API instead of WebSocket)
            await sendInitialMessage();
        }
        
        // Send initial message to start interview
        async function sendInitialMessage() {
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Create timeout promise (60 seconds for chat API)
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout - probeer het opnieuw')), 60000)
                );
                
                // Send to server
                const fetchPromise = fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: 'start',
                        session: currentSession
                    })
                });
                
                // Race between fetch and timeout
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                console.log('Chat response status:', response.status);
                const responseText = await response.text();
                console.log('Chat response text:', responseText);
                const data = JSON.parse(responseText);
                console.log('Chat response data:', data);
                
                // Hide typing indicator
                hideTypingIndicator();
                
                if (data.type === 'agent_message') {
                    addMessage(data.content, 'agent');
                    updateProgress(data.progress, data.fase, data.fase_name);
                    
                    // Update session with response
                    if (data.session) {
                        currentSession = data.session;
                    }
                    
                    // Generate AI suggestions based on the question (with small delay)
                    setTimeout(() => generateSuggestions(data.content), 300);
                } else if (data.type === 'error') {
                    addMessage('Sorry, er ging iets mis: ' + data.message, 'system');
                } else if (data.interview_complete) {
                    addMessage('Interview voltooid! Je kunt de resultaten nu exporteren.', 'system');
                    updateProgress(100, currentTotalFases, 'Voltooid');
                    hideSuggestions();
                }
            } catch (error) {
                console.error('Error sending initial message:', error);
                console.error('Error details:', error.message);
                hideTypingIndicator();
                
                // Better error messages
                const errorMsg = error.message.includes('timeout') 
                    ? 'Het starten van het interview duurt te lang. Probeer het opnieuw.'
                    : `Verbindingsfout: ${error.message}. Check de browser console voor details.`;
                
                addMessage(errorMsg, 'system');
            }
        }

        // Load existing session
        async function loadSession(sessionId) {
            try {
                // Fetch session info first to get template data
                const infoResponse = await fetch(`${API_BASE}/api/session/${sessionId}`);
                if (infoResponse.ok) {
                    const sessionInfo = await infoResponse.json();
                    currentTotalFases = sessionInfo.total_fases || 11;
                }
                
                // Fetch session data from backend
                const response = await fetch(`${API_BASE}/api/session/${sessionId}/export`);
                if (!response.ok) {
                    await showModal(
                        'Sessie Niet Gevonden',
                        'Deze sessie kon niet worden geladen van de server.',
                        'error',
                        [{ label: 'OK', value: true, primary: true }]
                    );
                    return;
                }
                
                const sessionData = await response.json();
                
                // Show chat interface
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('chatMessages').classList.remove('hidden');
                document.getElementById('inputArea').classList.remove('hidden');
                document.getElementById('progressIndicator').classList.remove('hidden');
                
                // Clear existing messages
                document.getElementById('chatMessages').innerHTML = '';
                
                // Set current session
                currentSessionId = sessionId;
                
                // Update UI
                const session = sessions.find(s => s.id === sessionId);
                updateSessionTitle(session.title, `Sessie geladen - ${session.date}`);
                
                // Render conversation history
                if (sessionData.conversation_history) {
                    sessionData.conversation_history.forEach(msg => {
                        if (msg.role === 'user') {
                            addMessage(msg.content, 'user');
                        } else if (msg.role === 'assistant') {
                            addMessage(msg.content, 'agent');
                        }
                    });
                }
                
                // Update progress (estimate based on messages)
                const progress = Math.min(100, (sessionData.conversation_history?.length || 0) * 5);
                updateProgress(progress, sessionData.status === 'completed' ? currentTotalFases : 1, 'Geladen');
                
                // Check if interview is completed
                if (sessionData.status === 'completed') {
                    addMessage('Dit interview is voltooid. Start een nieuw interview om verder te gaan.', 'system');
                }
                
                renderSessions();
            } catch (error) {
                console.error('Error loading session:', error);
                await showModal(
                    'Fout bij Laden',
                    'Er is een fout opgetreden bij het laden van de sessie: ' + error.message,
                    'error',
                    [{ label: 'OK', value: true, primary: true }]
                );
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message || !currentSessionId) return;

            // Add user message to UI
            addMessage(message, 'user');
            
            // Update conversation context
            updateContext(message);

            // Update session title with first message
            const session = sessions.find(s => s.id === currentSessionId);
            if (session && session.messageCount === 0) {
                // Use first 50 chars of message as title
                session.title = message.length > 50 ? message.substring(0, 50) + '...' : message;
                session.messageCount++;
                saveSessions();
                renderSessions();
            }

            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Hide suggestions after sending
            hideSuggestions();
            
            // Disable button temporarily
            const button = document.getElementById('sendButton');
            button.disabled = true;
            
            // Show typing indicator
            showTypingIndicator();

            try {
                // Create timeout promise (60 seconds for chat API)
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout - probeer het opnieuw')), 60000)
                );
                
                // Send to server via REST API with session data
                const fetchPromise = fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: message,
                        session: currentSession
                    })
                });
                
                // Race between fetch and timeout
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                const data = await response.json();
                
                // Hide typing indicator
                hideTypingIndicator();
                
                if (data.type === 'agent_message') {
                    addMessage(data.content, 'agent');
                    updateProgress(data.progress, data.fase, data.fase_name);
                    
                    // Update session with response
                    if (data.session) {
                        currentSession = data.session;
                    }
                    
                    // Generate AI suggestions based on the question (with small delay)
                    setTimeout(() => generateSuggestions(data.content), 300);
                } else if (data.type === 'error') {
                    addMessage('Sorry, er ging iets mis: ' + data.message, 'system');
                } else if (data.interview_complete) {
                    addMessage('Interview voltooid! Je kunt de resultaten nu exporteren.', 'system');
                    updateProgress(100, currentTotalFases, 'Voltooid');
                    hideSuggestions();
                }
            } catch (error) {
                console.error('Error sending message:', error);
                hideTypingIndicator();
                
                // Better error messages
                const errorMsg = error.message.includes('timeout') 
                    ? 'De vraag duurt te lang om te verwerken. Probeer het opnieuw of maak je antwoord korter.'
                    : 'Verbindingsfout. Probeer opnieuw.';
                
                showToast(errorMsg, 'error');
                addMessage(errorMsg, 'system');
            } finally {
                button.disabled = false;
            }
        }

        // Handle input keydown
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message-enter';
            typingDiv.innerHTML = `
                <div class="flex gap-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 bg-white border border-gray-200 px-5 py-3 rounded-2xl rounded-tl-md shadow-sm">
                        <div class="flex gap-1 items-center">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            
            // Scroll to bottom
            setTimeout(() => {
                typingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        // Add message
        function addMessage(content, type) {
            // Add to message history for back navigation
            if (type !== 'system') {
                messageHistory.push({ role: type, content: content });
                updateBackButtonVisibility();
            }
            
            const container = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-enter';
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex justify-end">
                        <div class="max-w-[80%] bg-gradient-to-r from-blue-600 to-purple-600 text-white px-5 py-3 rounded-2xl rounded-br-md shadow-md">
                            <div class="text-sm leading-relaxed">${escapeHtml(content)}</div>
                        </div>
                    </div>
                `;
            } else if (type === 'agent') {
                messageDiv.innerHTML = `
                    <div class="flex gap-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="flex-1 bg-white border border-gray-200 px-5 py-3 rounded-2xl rounded-tl-md shadow-sm">
                            <div class="text-sm leading-relaxed text-gray-800">${formatMessage(content)}</div>
                        </div>
                    </div>
                `;
            } else if (type === 'system') {
                messageDiv.innerHTML = `
                    <div class="flex justify-center">
                        <div class="bg-blue-50 border border-blue-200 text-blue-800 px-5 py-3 rounded-xl text-sm text-center shadow-sm">
                            ${escapeHtml(content)}
                        </div>
                    </div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.parentElement.scrollTop = container.parentElement.scrollHeight;
        }

        // Update progress based on conversation depth
        function updateProgress(progress, fase, faseName) {
            // Simple and effective progress calculation
            let calculatedProgress = 0;
            
            if (currentSession && currentSession.messages) {
                // Count total user messages (excluding the initial 'start')
                const totalUserMessages = currentSession.messages.filter(m => m.role === 'user' && m.content !== 'start').length;
                
                // Simple formula: each message adds ~3-4% progress
                // This gives visible feedback and feels responsive
                const progressPerMessage = 3.5;
                calculatedProgress = totalUserMessages * progressPerMessage;
                
                // Add bonus for fase completion (makes fase transitions feel rewarding)
                const completedFases = fase - 1;
                const faseBonus = completedFases * 5; // 5% bonus per completed fase
                calculatedProgress += faseBonus;
                
                // Ensure minimum visible progress (5% after first message)
                if (totalUserMessages > 0 && calculatedProgress < 5) {
                    calculatedProgress = 5;
                }
                
                // Ensure we're at least at the fase baseline
                const faseBaseline = ((fase - 1) / currentTotalFases) * 100;
                calculatedProgress = Math.max(calculatedProgress, faseBaseline);
                
                // Cap at 95% until interview is complete
                calculatedProgress = Math.min(calculatedProgress, 95);
                
                console.log(`Progress: Fase ${fase}/${currentTotalFases}, Total messages: ${totalUserMessages}, Progress: ${Math.round(calculatedProgress)}%`);
            } else {
                // Fallback to server-provided progress
                calculatedProgress = progress || 0;
            }
            
            // Smooth animation
            const progressBar = document.getElementById('progressBarTop');
            const progressPercent = document.getElementById('progressPercent');
            
            if (progressBar && progressPercent) {
                progressBar.style.width = calculatedProgress + '%';
                progressPercent.textContent = Math.round(calculatedProgress) + '%';
            }
            
            const subtitle = document.getElementById('sessionSubtitle');
            if (subtitle) {
                subtitle.textContent = `Fase ${fase}/${currentTotalFases}: ${faseName}`;
            }
            
            // Store progress in session for persistence
            if (currentSession) {
                currentSession.progress = calculatedProgress;
                currentSession.currentFase = fase;
                currentSession.faseName = faseName;
                saveSessions();
            }
        }

        // Format message
        function formatMessage(content) {
            let formatted = content;
            
            // Remove JSON blocks
            formatted = formatted.replace(/```json[\s\S]*?```/g, '');
            
            // Remove JSON lines
            let lines = formatted.split('\n');
            let inJson = false;
            let filteredLines = [];
            
            for (let line of lines) {
                if (line.trim().startsWith('{') || line.trim().startsWith('"')) {
                    inJson = true;
                }
                
                if (!inJson) {
                    filteredLines.push(line);
                }
                
                if (line.trim().endsWith('}')) {
                    inJson = false;
                }
            }
            
            formatted = filteredLines.join('\n');
            
            // Convert **bold** to <strong>
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>');
            
            // Convert bullet points
            formatted = formatted.replace(/^- (.+)$/gm, '<div class="ml-4">‚Ä¢ $1</div>');
            
            // Convert newlines to <br>
            formatted = formatted.replace(/\n/g, '<br>');
            
            // Clean up multiple <br> tags
            formatted = formatted.replace(/(<br>\s*){3,}/g, '<br><br>');
            
            return formatted;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Toast notification system
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast-enter pointer-events-auto';
            
            const icons = {
                success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
                error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
                warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            };
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.innerHTML = `
                <div class="flex items-center gap-3 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg min-w-[300px] max-w-md">
                    <div class="flex-shrink-0">
                        ${icons[type]}
                    </div>
                    <div class="flex-1 text-sm font-medium">
                        ${escapeHtml(message)}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 hover:bg-white hover:bg-opacity-20 rounded p-1 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('toast-exit');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }

        // Initialize
        initDarkMode();
        loadSessions();
    </script>
</body>
</html>
